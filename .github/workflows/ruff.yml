# GitHub Actions workflow for Ruff code formatting and linting
# è‡ªåŠ¨è¿è¡Œ Ruff æ ¼å¼æ£€æŸ¥å’Œä¿®å¤
#
# è§¦å‘æ¡ä»¶ï¼š
# 1. Push åˆ° main åˆ†æ”¯æ—¶ï¼šè‡ªåŠ¨æ ¼å¼åŒ–å¹¶æäº¤

name: Ruff Format Check

on:
  push:
    branches:
      - main
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'Makefile'
      - '.github/workflows/ruff.yml'

# è®¾ç½®å†™å…¥æƒé™ï¼Œå…è®¸è‡ªåŠ¨æäº¤æ ¼å¼åŒ–ä»£ç 
permissions:
  contents: write

jobs:
  ruff:
    name: Ruff Format & Lint
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. å®‰è£… uvï¼ˆé¡¹ç›®ä½¿ç”¨ uv ä½œä¸ºåŒ…ç®¡ç†å™¨ï¼‰
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "0.7.2"

      # 3. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 4. å®‰è£… ruff ä¾èµ–ï¼ˆæ ¹æ®é¡¹ç›®é…ç½®ï¼Œruff åœ¨ dev ä¾èµ–ç»„ä¸­ï¼‰
      - name: Install dependencies
        run: |
          uv sync --group dev

      # 5. è¿è¡Œ Ruff æ ¼å¼æ£€æŸ¥ï¼ˆä¸é¡¹ç›®çš„ make lint å‘½ä»¤ä¸€è‡´ï¼‰
      - name: Run Ruff format check
        id: ruff-format
        run: |
          set +e  # ä¸ç«‹å³é€€å‡ºå¤±è´¥

          echo "Running ruff check (uv run python -m ruff check .)..."
          uv run python -m ruff check .
          ruff_check_result=$?

          echo "Running ruff format diff check (uv run python -m ruff format src --diff)..."
          uv run python -m ruff format src --diff
          ruff_format_result=$?

          echo "Running import sorting check (uv run python -m ruff check --select I src)..."
          uv run python -m ruff check --select I src
          ruff_import_result=$?

          # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•é”™è¯¯
          if [ $ruff_check_result -eq 0 ] && [ $ruff_format_result -eq 0 ] && [ $ruff_import_result -eq 0 ]; then
            echo "ruff_format_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Ruff format check passed"
          else
            echo "ruff_format_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Ruff format check failed"
            echo "::warning::Ruff format check found issues that should be addressed"

            # æ±‡æ€»é”™è¯¯ä¿¡æ¯
            echo "## Ruff Format Issues Summary" > $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following formatting issues were found:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # è¿è¡Œ ruff check ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
            echo "### Detailed Issues:" >> $GITHUB_STEP_SUMMARY
            uv run python -m ruff check . --output-format=github >> $GITHUB_STEP_SUMMARY 2>&1 || true

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To fix these issues locally, run:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "make format" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      # 6. é’ˆå¯¹ä¸åŒäº‹ä»¶ç±»å‹æ‰§è¡Œä¸åŒæ“ä½œ
      - name: Process Ruff Results
        if: ${{ github.event_name == 'push' }}
        env:
          GIT_AUTHOR_NAME: "GitHub Actions"
          GIT_AUTHOR_EMAIL: "actions@github.com"
          GIT_COMMITTER_NAME: "GitHub Actions"
          GIT_COMMITTER_EMAIL: "actions@github.com"
        run: |
          echo "Processing push event to main branch..."

          # æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰æœªæäº¤çš„ä¿®æ”¹
          if ! git diff --exit-code --quiet; then
            echo "âš ï¸  Warning: There are uncommitted changes before formatting"
            echo "The formatting process might need to handle this specially."
          fi

          # å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ ¼å¼é—®é¢˜
          echo "Checking for formatting issues..."
          set +e
          uv run python -m ruff check . --quiet
          has_ruff_issues=$?
          set -e

          if [ $has_ruff_issues -eq 0 ]; then
            echo "âœ… No formatting issues found"
            exit 0
          fi

          echo "Formatting issues detected, running automatic fixes..."

          # è‡ªåŠ¨åº”ç”¨æ ¼å¼ä¿®å¤ï¼ˆä¸é¡¹ç›®çš„ make format å‘½ä»¤ä¸€è‡´ï¼‰
          echo "Running uv run ruff format ."
          uv run ruff format .

          echo "Running uv run ruff check . --fix"
          uv run ruff check . --fix

          echo "Running uv run python -m ruff check --select I src --fix"
          uv run python -m ruff check --select I src --fix

          # æ£€æŸ¥æ˜¯å¦æœ‰æ ¼å¼å˜æ›´
          echo "Checking for formatting changes..."
          if git diff --exit-code --quiet; then
            echo "âœ… No formatting changes needed"
          else
            echo "ğŸ“ Formatting changes detected"
            echo "Changed files:"
            git diff --name-only

            # æ·»åŠ æ‰€æœ‰å˜æ›´å¹¶æäº¤
            git add .
            git commit -m "style: auto-format with ruff [skip ci]"

            echo "ğŸ“¤ Pushing formatting changes..."
            git push
            echo "âœ… Formatting changes committed and pushed"
          fi
